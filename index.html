<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>精读书卡 - 逐章精读模式</title>
    
    <!-- PWA Manifest for Android Icon -->
    <link rel="manifest" href="data:application/manifest+json,{'name':'精读书卡','short_name':'精读卡','start_url':'.','display':'standalone','background_color':'#2c3e50','theme_color':'#58CC02','icons':[{'src':'https://cdn-icons-png.flaticon.com/512/3145/3145765.png','sizes':'512x512','type':'image/png'}]}">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #2c3e50; 
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }
        #app-container {
            width: 100vw;
            height: 100vh;
            background-color: white;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        @media (min-aspect-ratio: 9/15) {
            #app-container {
                width: auto;
                height: 90vh;
                aspect-ratio: 9 / 16;
                border-radius: 2rem;
                border: 8px solid #1a1a1a;
            }
        }
        .duo-button-active:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 0 rgba(0,0,0,0.1);
        }
        .custom-scroll {
            scrollbar-width: thin;
            scrollbar-color: rgba(0,0,0,0.1) transparent;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const DB = {
            SAVE_KEY: 'JINGDU_SHUKA_DATA_V7',
            get: () => {
                try {
                    const data = localStorage.getItem(DB.SAVE_KEY);
                    return data ? JSON.parse(data) : { books: [] };
                } catch (e) { return { books: [] }; }
            },
            save: (data) => localStorage.setItem(DB.SAVE_KEY, JSON.stringify(data))
        };

        const STYLE_PACKS = [
            { name: '活力绿', primary: '#58CC02', secondary: '#46A302', bg: '#F2FFE9', text: '#2B5E01' },
            { name: '深海蓝', primary: '#1CB0F6', secondary: '#1899D6', bg: '#F0F9FF', text: '#0C4A6E' },
            { name: '晚霞橙', primary: '#FF9600', secondary: '#D97E00', bg: '#FFF9F0', text: '#7C4A00' },
            { name: '梦幻紫', primary: '#CE82FF', secondary: '#AF6EDB', bg: '#FAF5FF', text: '#5D2C80' }
        ];

        const GROQ_API_KEY = "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";

        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const DuoButton = ({ children, onClick, color = "#58CC02", shadowColor = "#46A302", className = "", disabled = false, type = "button" }) => (
            <button 
                type={type}
                onClick={onClick}
                disabled={disabled}
                style={{ backgroundColor: color, borderBottom: `4px solid ${shadowColor}` }}
                className={`px-4 py-3 rounded-2xl font-bold text-white transition-all duo-button-active flex items-center justify-center gap-2 ${disabled ? 'opacity-50' : ''} ${className}`}
            >
                {children}
            </button>
        );

        const App = () => {
            const [view, setView] = useState('home');
            const [books, setBooks] = useState([]);
            const [currentBook, setCurrentBook] = useState(null);
            const [cardIdx, setCardIdx] = useState(0);
            const [loading, setLoading] = useState(false);

            useEffect(() => { setBooks(DB.get().books); }, []);
            useEffect(() => { DB.save({ books }); }, [books]);

            const handleGenerate = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const bookTitle = formData.get('title');
                if (!bookTitle) return;

                setLoading(true);

                try {
                    const prompt = `你是一个深度的书籍拆解专家。请针对书籍《${bookTitle}》生成一套精读卡片。
                    要求：
                    1. 识别该书的主要章节或核心逻辑框架。
                    2. 为每一个核心章节或重要知识点单独生成一张卡片（总共生成5-8张卡片）。
                    3. 每张卡片需包含：章节标题(title)、本章核心观点(model)、3个关键细节要点(points: array)、1个常见误区(pitfalls: array)、1个行动建议(actions: array)、1个启发思考题(quiz)。
                    
                    必须严格返回 JSON 格式：
                    {
                        "author": "作者姓名",
                        "cards": [
                            {
                                "title": "章节标题",
                                "model": "核心观点",
                                "points": ["点1", "点2", "点3"],
                                "pitfalls": ["误区1"],
                                "actions": ["建议1"],
                                "quiz": "思考题"
                            }
                        ]
                    }`;

                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: { 
                            'Authorization': `Bearer ${GROQ_API_KEY}`, 
                            'Content-Type': 'application/json' 
                        },
                        body: JSON.stringify({
                            model: "llama-3.3-70b-versatile",
                            messages: [
                                { role: "system", content: "You are a professional book analyst. You must output a valid JSON object." },
                                { role: "user", content: prompt }
                            ],
                            response_format: { type: "json_object" }
                        })
                    });

                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    
                    const data = await response.json();
                    const aiData = JSON.parse(data.choices[0].message.content);
                    
                    // 数据清洗：确保数组字段始终存在，防止渲染崩溃
                    const cleanedCards = (aiData.cards || []).map(card => ({
                        ...card,
                        points: Array.isArray(card.points) ? card.points : [],
                        pitfalls: Array.isArray(card.pitfalls) ? card.pitfalls : [],
                        actions: Array.isArray(card.actions) ? card.actions : []
                    }));

                    const newBook = {
                        id: Date.now(),
                        title: bookTitle,
                        author: aiData.author || "未知作者",
                        style: STYLE_PACKS[Math.floor(Math.random() * STYLE_PACKS.length)],
                        cards: cleanedCards
                    };
                    
                    setBooks(prev => [newBook, ...prev]);
                    setView('home');
                } catch (err) {
                    console.error("Generate Error:", err);
                    alert("生成失败，请稍后尝试简化书名重试。");
                } finally {
                    setLoading(false);
                }
            };

            const deleteBook = (id, e) => {
                e.stopPropagation();
                setBooks(prev => prev.filter(b => b.id !== id));
            };

            return (
                <div id="app-container">
                    {view === 'home' && (
                        <div className="flex flex-col h-full animate-fade-in" key="view-home">
                            <header className="p-6 flex justify-between items-center">
                                <h1 className="text-2xl font-black text-gray-800 tracking-tight">精读书卡</h1>
                                <Icon name="library" className="text-gray-400" />
                            </header>
                            <main className="flex-1 overflow-y-auto p-4 space-y-4 custom-scroll">
                                {books.length === 0 ? (
                                    <div className="h-full flex flex-col items-center justify-center text-gray-300">
                                        <Icon name="book-open" size={64} className="mb-4 opacity-20" />
                                        <p className="font-bold">输入书名，AI 逐章为您精读</p>
                                    </div>
                                ) : (
                                    books.map(b => (
                                        <div key={b.id} onClick={() => { setCurrentBook(b); setCardIdx(0); setView('reader'); }}
                                             className="group p-4 rounded-3xl border-2 border-gray-100 flex gap-4 items-center active:scale-95 transition-transform cursor-pointer relative">
                                            <div className="w-12 h-16 rounded-xl shadow-sm flex items-center justify-center text-white font-bold shrink-0" style={{backgroundColor: b.style?.primary || '#58CC02'}}>
                                                {b.cards?.length || 0}
                                            </div>
                                            <div className="flex-1 overflow-hidden">
                                                <h3 className="font-bold truncate pr-6">{b.title}</h3>
                                                <p className="text-xs text-gray-400">{b.author} · {b.cards?.length || 0}个章节</p>
                                            </div>
                                            <button onClick={(e) => deleteBook(b.id, e)} className="p-2 text-gray-300 hover:text-red-400 transition-colors">
                                                <Icon name="trash-2" size={18} />
                                            </button>
                                        </div>
                                    ))
                                )}
                            </main>
                            <footer className="p-6">
                                <DuoButton onClick={() => setView('add')} className="w-full py-4 shadow-lg">
                                    <Icon name="plus" /> 开始逐章精读
                                </DuoButton>
                            </footer>
                        </div>
                    )}

                    {view === 'add' && (
                        <div className="flex flex-col h-full p-6 animate-fade-in" key="view-add">
                            <header className="flex items-center gap-4 mb-12">
                                <button onClick={() => setView('home')} className="p-2" disabled={loading}><Icon name="chevron-left" /></button>
                                <h2 className="text-xl font-bold">新增书籍精读</h2>
                            </header>
                            
                            {loading ? (
                                <div className="flex-1 flex flex-col items-center justify-center text-center">
                                    <div className="relative mb-8">
                                        <div className="w-20 h-20 border-4 border-gray-100 border-t-blue-500 rounded-full animate-spin"></div>
                                        <Icon name="layout" size={32} className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-blue-500" />
                                    </div>
                                    <p className="text-lg font-bold text-gray-700">正在逐章拆解书籍内容...</p>
                                    <p className="text-sm text-gray-400 mt-2 px-10">我们将为每个核心章节生成一张专属知识卡片</p>
                                </div>
                            ) : (
                                <div className="flex-1 flex flex-col">
                                    <div className="mb-10">
                                        <h3 className="text-2xl font-black mb-2 text-gray-800">你想深度阅读哪本书？</h3>
                                        <p className="text-gray-400">我们将为您提供章节级的精读摘要</p>
                                    </div>
                                    <form onSubmit={handleGenerate} className="space-y-6">
                                        <input 
                                            required 
                                            name="title" 
                                            autoFocus
                                            placeholder="例如：《非暴力沟通》或《认知觉醒》" 
                                            className="w-full p-5 bg-gray-50 rounded-2xl outline-none border-4 border-transparent focus:border-blue-400 font-bold text-xl transition-all shadow-inner" 
                                        />
                                        <DuoButton type="submit" color="#3B82F6" shadowColor="#2563EB" className="w-full py-5 text-lg">开启深度拆解</DuoButton>
                                    </form>
                                </div>
                            )}
                        </div>
                    )}

                    {view === 'reader' && currentBook && currentBook.cards?.[cardIdx] && (
                        <div className="flex flex-col h-full bg-white animate-fade-in" key="view-reader">
                            <header className="p-4 flex items-center justify-between border-b">
                                <button onClick={() => setView('home')}><Icon name="x" size={20}/></button>
                                <div className="flex flex-col items-center overflow-hidden px-4">
                                    <span className="font-bold text-sm truncate w-full text-center">{currentBook.title}</span>
                                    <span className="text-[10px] text-gray-400 uppercase tracking-widest">{currentBook.author}</span>
                                </div>
                                <span className="text-xs font-bold text-gray-400">
                                    {cardIdx + 1}/{currentBook.cards.length}
                                </span>
                            </header>
                            
                            <div className="w-full h-1.5 bg-gray-100">
                                <div className="h-full transition-all duration-300" style={{width: `${((cardIdx+1)/currentBook.cards.length)*100}%`, backgroundColor: currentBook.style?.primary || '#58CC02'}}></div>
                            </div>

                            <main className="flex-1 p-5 overflow-y-auto custom-scroll" style={{backgroundColor: currentBook.style?.bg || '#F2FFE9'}}>
                                <div className="bg-white rounded-3xl p-6 min-h-full flex flex-col gap-6 shadow-sm border" style={{borderColor: (currentBook.style?.primary || '#58CC02') + '33'}}>
                                    <div className="space-y-1">
                                        <span className="text-[10px] font-bold py-1 px-2 rounded bg-gray-100 text-gray-500 uppercase tracking-tighter">CHAPTER {cardIdx + 1}</span>
                                        <h2 className="text-xl font-black leading-tight" style={{color: currentBook.style?.text || '#2B5E01'}}>
                                            {currentBook.cards[cardIdx].title || "无标题"}
                                        </h2>
                                    </div>

                                    <div className="p-4 rounded-2xl bg-gray-50 border-l-4" style={{borderColor: currentBook.style?.primary || '#58CC02'}}>
                                        <p className="text-sm italic font-bold leading-relaxed text-gray-700">“{currentBook.cards[cardIdx].model || "本章暂无摘要"}”</p>
                                    </div>

                                    <section>
                                        <h4 className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                                            <Icon name="check-circle" size={14} /> 核心要点
                                        </h4>
                                        <ul className="space-y-3">
                                            {(currentBook.cards[cardIdx].points || []).map((p, i) => (
                                                <li key={i} className="text-sm flex gap-3 text-gray-600">
                                                    <span className="shrink-0 w-5 h-5 rounded-full flex items-center justify-center text-[10px] text-white font-bold" style={{backgroundColor: currentBook.style?.primary || '#58CC02'}}>{i + 1}</span>
                                                    {p}
                                                </li>
                                            ))}
                                        </ul>
                                    </section>

                                    {currentBook.cards[cardIdx].pitfalls?.length > 0 && (
                                        <section className="bg-amber-50 p-4 rounded-2xl border border-amber-100">
                                            <h4 className="text-xs font-bold text-amber-600 uppercase tracking-widest mb-2 flex items-center gap-2">
                                                <Icon name="alert-triangle" size={14} /> 认知误区
                                            </h4>
                                            {currentBook.cards[cardIdx].pitfalls.map((p, i) => <p key={i} className="text-xs text-amber-800 leading-relaxed">• {p}</p>)}
                                        </section>
                                    )}

                                    <section>
                                        <h4 className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                                            <Icon name="zap" size={14} /> 本章行动建议
                                        </h4>
                                        <div className="flex flex-wrap gap-2">
                                            {(currentBook.cards[cardIdx].actions || []).map((a, i) => (
                                                <span key={i} className="text-xs bg-gray-100 text-gray-800 px-3 py-1.5 rounded-xl font-bold border border-gray-200">{a}</span>
                                            ))}
                                        </div>
                                    </section>

                                    <div className="pt-6 border-t border-dashed mt-auto">
                                        <p className="text-[10px] font-bold text-gray-400 uppercase mb-2">深度启发</p>
                                        <p className="text-sm font-bold text-gray-800 bg-gray-50 p-3 rounded-xl italic">? {currentBook.cards[cardIdx].quiz || "尝试总结本章内容对你的启发"}</p>
                                    </div>
                                </div>
                            </main>

                            <footer className="p-5 flex gap-3 bg-white border-t">
                                <DuoButton onClick={() => setCardIdx(Math.max(0, cardIdx - 1))} color="#f3f4f6" shadowColor="#d1d5db" className="flex-1 !text-gray-500" disabled={cardIdx === 0}>上一个章节</DuoButton>
                                <DuoButton onClick={() => cardIdx < currentBook.cards.length - 1 ? setCardIdx(cardIdx + 1) : setView('home')} className="flex-1" color={currentBook.style?.primary || '#58CC02'} shadowColor={currentBook.style?.secondary || '#46A302'}>
                                    {cardIdx === currentBook.cards.length - 1 ? '完成精读' : '下一个章节'}
                                </DuoButton>
                            </footer>
                        </div>
                    )}
                </div>
            );
        };

        window.onload = () => { ReactDOM.createRoot(document.getElementById('root')).render(<App />); };
    </script>
</body>
</html>